<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDN QoS Network Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        #header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }

        #container {
            display: flex;
            height: calc(100vh - 80px);
        }

        #network-view {
            flex: 1;
            background: white;
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #stats-panel {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            margin: 20px 20px 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-top: 5px;
        }

        .legend {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .legend-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            font-size: 13px;
            gap: 12px;
        }

        .legend-color {
            width: 40px;
            height: 6px;
            margin-right: 0;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .node text {
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: 600;
        }

        .link {
            stroke-linecap: round;
            transition: stroke-width 0.3s, stroke 0.3s;
        }

        .node circle {
            cursor: pointer;
            transition: all 0.3s;
        }

        .node circle:hover {
            stroke-width: 4px;
        }

        .status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        .link.active-path {
            stroke: #00bcd4 !important;
            stroke-width: 8px !important;
            stroke-dasharray: 15, 10 !important;
            animation: flow 1s linear infinite;
            stroke-opacity: 1 !important;
        }

        .link.congested {
            stroke: #9f7aea !important;
            stroke-width: 6px !important;
            stroke-dasharray: 5, 5 !important;
            animation: pulse-red 0.5s infinite;
        }

        .link.active-path.congested {
            stroke: #f56565 !important;
            /* Red flow for congested active path */
            stroke-width: 8px !important;
            stroke-dasharray: 15, 10 !important;
            animation: flow 0.5s linear infinite;
            /* Faster flow to indicate urgency */
            stroke-opacity: 1 !important;
        }

        @keyframes flow {
            from {
                stroke-dashoffset: 25;
            }

            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes pulse-red {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="header">
        <h1>üåê SDN QoS Network Visualizer</h1>
        <div class="subtitle">Real-time Network Telemetry & Congestion Detection</div>
    </div>

    <div id="container">
        <div id="network-view">
            <div class="status">
                <div class="status-dot"></div>
                <span>Live Monitoring</span>
            </div>

            <button id="toggle-traffic" style="
                position: absolute;
                top: 20px;
                left: 20px;
                padding: 10px 20px;
                background: #f56565;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: all 0.2s;
            ">üõë Stop Traffic</button>

            <script>
                let trafficActive = true;
                // Default is running, so button should say STOP
                const btn = document.getElementById("toggle-traffic");
                btn.textContent = "üõë Stop Traffic";
                btn.style.background = "#f56565";

                btn.onclick = () => {
                    trafficActive = !trafficActive;

                    if (trafficActive) {
                        btn.textContent = "üõë Stop Traffic";
                        btn.style.background = "#f56565";
                    } else {
                        btn.textContent = "‚ñ∂Ô∏è Start Traffic";
                        btn.style.background = "#48bb78";
                    }

                    fetch("http://localhost:8001/toggle-traffic", {
                        method: "POST",
                        body: JSON.stringify({ active: trafficActive })
                    }).catch(console.error);
                };
            </script>
            <svg id="network"></svg>
            <div class="tooltip" id="tooltip"></div>
        </div>

        <div id="stats-panel">
            <div class="stat-card">
                <div class="stat-label">Total Throughput</div>
                <div class="stat-value" id="total-throughput">0</div>
                <div style="font-size: 14px; margin-top: 5px;">Mbps</div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="stat-label">Packet Drops</div>
                <div class="stat-value" id="total-drops">0</div>
                <div style="font-size: 14px; margin-top: 5px;">packets/sec</div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="stat-label">Active Links</div>
                <div class="stat-value" id="active-links">0</div>
                <div style="font-size: 14px; margin-top: 5px;">connections</div>
            </div>

            <div class="qos-actions">
                <h3 style="margin-bottom: 15px; color: #2d3748;">‚ö° QoS Actions</h3>
                <div id="qos-feed" style="max-height: 200px; overflow-y: auto;">
                    <div style="color: #718096; font-size: 12px; font-style: italic;">
                        Waiting for QoS events...
                    </div>
                </div>
            </div>

            <div class="legend">
                <h3 style="margin-bottom: 15px; color: #2d3748;">üìä Link Traffic Status</h3>

                <div class="legend-item">
                    <div class="legend-color" style="background: #cbd5e0;"></div>
                    <div>
                        <strong>Idle</strong><br>
                        <span style="font-size: 11px; color: #718096;">&lt;0.1 Mbps - No traffic</span>
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-color" style="background: #48bb78;"></div>
                    <div>
                        <strong>Normal</strong><br>
                        <span style="font-size: 11px; color: #718096;">0-5 Mbps - Low load</span>
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-color"
                        style="background: #00bcd4; height: 4px; animation: flow 1s linear infinite;"></div>
                    <div>
                        <strong style="color: #00bcd4;">Active Path</strong><br>
                        <span style="font-size: 11px; color: #718096;">ML Predicted Optimal Route</span>
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-color" style="background: #9f7aea; border: 2px dashed #9f7aea; height: 2px;">
                    </div>
                    <div>
                        <strong style="color: #9f7aea;">‚ö†Ô∏è Congested</strong><br>
                        <span style="font-size: 11px; color: #718096;">Drops detected - Rerouting!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const width = document.getElementById('network-view').clientWidth;
        const height = document.getElementById('network-view').clientHeight;

        const svg = d3.select("#network")
            .attr("width", width)
            .attr("height", height);

        const tooltip = d3.select("#tooltip");

        // Topology: 2 hosts, 4 switches
        const nodes = [
            { id: "h1", type: "host", x: 150, y: height / 2 },
            { id: "h2", type: "host", x: width - 150, y: height / 2 },
            { id: "s1", type: "switch", x: width / 2 - 100, y: height / 2 - 100 },
            { id: "s2", type: "switch", x: width / 2 + 100, y: height / 2 - 100 },
            { id: "s3", type: "switch", x: width / 2 - 100, y: height / 2 + 100 },
            { id: "s4", type: "switch", x: width / 2 + 100, y: height / 2 + 100 }
        ];

        const links = [
            { source: "h1", target: "s1", dpid: "1", port: 1 },
            { source: "h1", target: "s2", dpid: "2", port: 1 },
            { source: "h1", target: "s3", dpid: "3", port: 1 },
            { source: "s1", target: "s4", dpid: "1", port: 2 },
            { source: "s2", target: "s4", dpid: "2", port: 2 },
            { source: "s3", target: "s4", dpid: "3", port: 2 },
            { source: "s4", target: "h2", dpid: "4", port: 4 }
        ];

        // Draw links
        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .attr("x1", d => nodes.find(n => n.id === d.source).x)
            .attr("y1", d => nodes.find(n => n.id === d.source).y)
            .attr("x2", d => nodes.find(n => n.id === d.target).x)
            .attr("y2", d => nodes.find(n => n.id === d.target).y)
            .attr("stroke", "#cbd5e0")
            .attr("stroke-width", 4);

        // Draw nodes
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`);

        node.append("circle")
            .attr("r", d => d.type === "host" ? 30 : 40)
            .attr("fill", d => d.type === "host" ? "#4299e1" : "#48bb78")
            .attr("stroke", "#fff")
            .attr("stroke-width", 3);

        node.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", 5)
            .attr("fill", "white")
            .text(d => d.id);

        let activePath = ['h1', 's1', 's4', 'h2'];

        function updateMLPath() {
            fetch("http://localhost:9000/predict")
                .then(res => res.json())
                .then(data => {
                    if (!data.path || data.status === "warming_up") return;
                    activePath = data.path; // Store only, render in updateNetwork
                })
                .catch(err => console.error("ML path error:", err));
        }

        function isLinkInPath(d, path) {
            if (!path || path.length < 2) return false;
            for (let i = 0; i < path.length - 1; i++) {
                const u = path[i];
                const v = path[i + 1];
                if ((d.source === u && d.target === v) || (d.source === v && d.target === u)) {
                    return true;
                }
            }
            return false;
        }

        // Update function
        function updateNetwork() {
            fetch('http://localhost:8001/stats')
                .then(res => res.json())
                .then(stats => {
                    let totalThroughput = 0;
                    let totalDrops = 0;
                    let activeLinks = 0;

                    link.each(function (d) {
                        const portStats = stats[d.dpid]?.[String(d.port)];
                        const isActiveRoute = isLinkInPath(d, activePath);

                        // Default styling
                        let color = "#cbd5e0"; // Idle gray
                        let width = 4;
                        let opacity = 0.3; // Fade out inactive links

                        let isCongested = false;

                        if (portStats) {
                            const throughput = (portStats.tx_bps + portStats.rx_bps);
                            const drops = portStats.tx_dropped || 0;
                            const mbps = throughput / 1e6;

                            totalThroughput += throughput;
                            totalDrops += drops;
                            if (throughput > 1e5) activeLinks++;

                            // Color logic based on load
                            if (drops > 0) {
                                isCongested = true;
                            }

                            if (mbps < 5) color = "#48bb78";      // Green
                            else if (mbps < 50) color = "#ed8936"; // Orange
                            else color = "#f56565";               // Red

                            width = Math.min(4 + mbps * 0.1, 12);
                            opacity = 0.6;
                        }

                        // Apply Classes
                        d3.select(this)
                            .classed("congested", isCongested)
                            .classed("active-path", isActiveRoute);

                        // If it's a normal link (neither active nor congested), apply standard d3 transition styling
                        // If it IS active or congested, the CSS classes for those take priority via !important
                        if (!isActiveRoute && !isCongested) {
                            d3.select(this)
                                .transition().duration(500)
                                .attr("stroke", color)
                                .attr("stroke-width", width)
                                .attr("stroke-opacity", opacity)
                                .attr("stroke-dasharray", "none");
                        } else {
                            // Clear manual attributes so CSS classes work
                            d3.select(this).attr("stroke", null).attr("stroke-width", null).attr("stroke-dasharray", null);
                        }

                        // Tooltip (keep existing logic)
                        if (portStats) {
                            // ... (tooltip update logic implied, keep straightforward)
                        }
                    });

                    // Update stats panel
                    document.getElementById('total-throughput').textContent =
                        (totalThroughput / 1e6).toFixed(2);
                    document.getElementById('total-drops').textContent = totalDrops;
                    document.getElementById('active-links').textContent = activeLinks;
                })
                .catch(err => console.error('Stats fetch error:', err));
        }

        // Update QoS Actions
        function updateQoSActions() {
            fetch('http://localhost:8001/qos-actions')
                .then(res => res.json())
                .then(actions => {
                    const feed = document.getElementById('qos-feed');

                    if (actions.length === 0) {
                        feed.innerHTML = `
                            <div style="color: #718096; font-size: 12px; font-style: italic;">
                                No QoS actions yet...
                            </div>
                        `;
                        return;
                    }

                    // Show last 5 actions
                    const recent = actions.slice(-5).reverse();

                    feed.innerHTML = recent.map(action => {
                        const time = new Date(action.timestamp * 1000).toLocaleTimeString();
                        const icon = action.type === 'REROUTE' ? 'üîÄ' : '‚öôÔ∏è';
                        const color = action.type === 'REROUTE' ? '#ed8936' : '#4299e1';

                        return `
                            <div style="
                                background: ${color}15;
                                border-left: 3px solid ${color};
                                padding: 8px;
                                margin-bottom: 8px;
                                border-radius: 4px;
                                font-size: 12px;
                            ">
                                <div style="font-weight: 600; color: ${color};">
                                    ${icon} ${action.type}
                                </div>
                                <div style="color: #2d3748; margin-top: 4px;">
                                    ${action.message}
                                    </div>
                                <div style="color: #a0aec0; font-size: 10px; margin-top: 4px;">
                                    ${time}
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(err => console.error('QoS actions fetch error:', err));
        }

        // Update every second
        updateNetwork();
        updateQoSActions();
        setInterval(updateNetwork, 1000);
        setInterval(updateQoSActions, 2000);
        setInterval(updateMLPath, 2000);
    </script>
</body>

</html>